!function(e){"use strict";if("function"==typeof require&&"object"==typeof exports&&"object"==typeof module)e(require("knockout"),exports);else if("function"==typeof define&&define.amd)define(["knockout","exports"],e);else{if("undefined"==typeof ko)throw new Error("Knockout is required, please ensure it is loaded before loading this mapping plug-in");e(ko,ko.mapping={})}}((function(e,r){"use strict";function t(){for(var e,r,t,n=arguments,a=n.length,i={},o=[];a--;)for(e=(t=n[a]).length;e--;)i[r=t[e]]||(i[r]=1,o.push(r));return o}function n(e,a){var i;for(var o in a)if(a.hasOwnProperty(o)&&a[o])if(i=r.getType(e[o]),o&&e[o]&&"array"!==i&&"string"!==i)n(e[o],a[o]);else{var u="array"===r.getType(e[o])&&"array"===r.getType(a[o]);e[o]=u?t(e[o],a[o]):a[o]}}function a(e,r){var t={};return n(t,e),n(t,r),t}function i(e,r){for(var t=a({},e),n=T.length-1;n>=0;n--){var i=T[n];t[i]&&(t[""]instanceof Object||(t[""]={}),t[""][i]=t[i],delete t[i])}return r&&(t.ignore=o(r.ignore,t.ignore),t.include=o(r.include,t.include),t.copy=o(r.copy,t.copy),t.observe=o(r.observe,t.observe)),t.ignore=o(t.ignore,I.ignore),t.include=o(t.include,I.include),t.copy=o(t.copy,I.copy),t.observe=o(t.observe,I.observe),t.mappedProperties=t.mappedProperties||{},t.copiedProperties=t.copiedProperties||{},t}function o(t,n){return void 0===t?t=[]:"array"!==r.getType(t)&&(t=[t]),void 0===n?n=[]:"array"!==r.getType(n)&&(n=[n]),e.utils.arrayGetDistinctValues(t.concat(n))}function u(r,t){var n=e.dependentObservable;e.dependentObservable=function(t,n,a){a=a||{},t&&"object"==typeof t&&(a=t);var i=a.deferEvaluation,o=a.pure,u=!1;a.deferEvaluation=!0;var s=m(t,n,a);return i||o||(s=function(t){var n=e.dependentObservable;e.dependentObservable=m;var a=e.isWriteableObservable(t);e.dependentObservable=n;var i=m({read:function(){return u||(e.utils.arrayRemoveItem(r,t),u=!0),t.apply(t,arguments)},write:a&&function(e){return t(e)},deferEvaluation:!0});return i.__DO=t,i}(s),r.push(s)),s},e.dependentObservable.fn=m.fn,e.computed=e.dependentObservable;var a=t();return e.dependentObservable=n,e.computed=e.dependentObservable,a}function s(t,n,i,o,l,y,g){var m="array"===r.getType(e.utils.unwrapObservable(n));if(y=y||"",r.isMapped(t)){var k=e.utils.unwrapObservable(t)[w];i=a(k,i)}var T={data:n,parent:g||l},j=function(){return i[o]&&i[o].create instanceof Function},I=function(r){return u(O,(function(){return e.utils.unwrapObservable(l)instanceof Array?i[o].create({data:r||T.data,parent:T.parent,skip:x}):i[o].create({data:r||T.data,parent:T.parent})}))},E=function(){return i[o]&&i[o].update instanceof Function},P=function(r,t){var n={data:t||T.data,parent:T.parent,target:e.utils.unwrapObservable(r)};return e.isWriteableObservable(r)&&(n.observable=r),i[o].update(n)},J=h.get(n);if(J)return J;if(o=o||"",m){var _=[],W=!1,D=function(e){return e};i[o]&&i[o].key&&(D=i[o].key,W=!0),e.isObservable(t)||((t=e.observableArray([])).mappedRemove=function(e){var r="function"==typeof e?e:function(r){return r===D(e)};return t.remove((function(e){return r(D(e))}))},t.mappedRemoveAll=function(r){var n=c(r,D);return t.remove((function(r){return-1!==e.utils.arrayIndexOf(n,D(r))}))},t.mappedDestroy=function(e){var r="function"==typeof e?e:function(r){return r===D(e)};return t.destroy((function(e){return r(D(e))}))},t.mappedDestroyAll=function(r){var n=c(r,D);return t.destroy((function(r){return-1!==e.utils.arrayIndexOf(n,D(r))}))},t.mappedIndexOf=function(r){var n=c(t(),D),a=D(r);return e.utils.arrayIndexOf(n,a)},t.mappedGet=function(e){return t()[t.mappedIndexOf(e)]},t.mappedCreate=function(r){if(-1!==t.mappedIndexOf(r))throw new Error("There already is an object with the key that you specified.");var n=j()?I(r):r;if(E()){var a=P(n,r);e.isWriteableObservable(n)?n(a):n=a}return t.push(n),n});var S=c(e.utils.unwrapObservable(t),D).sort(),A=c(n,D);W&&A.sort();var N,M,C,q=e.utils.compareArrays(S,A),F={},R=e.utils.unwrapObservable(n),$={},G=!0;for(N=0,M=R.length;M>N;N++){if(void 0===(C=D(R[N]))||C instanceof Object){G=!1;break}$[C]=R[N]}var K,V,z=[],B=0;for(N=0,M=q.length;M>N;N++){C=q[N];var H,L=y+"["+b(N)+"]";switch(C.status){case"added":H=s(void 0,K=G?$[C.value]:f(e.utils.unwrapObservable(n),C.value,D),i,o,t,L,l),j()||(H=e.utils.unwrapObservable(H)),V=p(e.utils.unwrapObservable(n),K,F),H===x?B++:z[V-B]=H,F[V]=!0;break;case"retained":K=G?$[C.value]:f(e.utils.unwrapObservable(n),C.value,D),s(H=f(t,C.value,D),K,i,o,t,L,l),z[V=p(e.utils.unwrapObservable(n),K,F)]=H,F[V]=!0;break;case"deleted":H=f(t,C.value,D)}_.push({event:C.status,item:H})}t(z),i[o]&&i[o].arrayChanged&&e.utils.arrayForEach(_,(function(e){i[o].arrayChanged(e.event,e.item)}))}else if(d(n)){if(!(t=e.utils.unwrapObservable(t))){if(j()){var Q=I();return E()&&(Q=P(Q)),Q}if(E())return P();t={}}if(E()&&(t=P(t)),h.save(n,t),E())return t;v(n,(function(a){var o=y.length?y+"."+b(a):b(a);if(-1===e.utils.arrayIndexOf(i.ignore,o)){if(-1!==e.utils.arrayIndexOf(i.copy,o))return void(t[a]=n[a]);if("object"!=typeof n[a]&&"array"!==r.getType(n[a])&&i.observe.length>0&&-1===e.utils.arrayIndexOf(i.observe,o))return t[a]=n[a],void(i.copiedProperties[o]=!0);var u=h.get(n[a]),p=s(t[a],n[a],i,a,t,o,t),l=u||p;if(i.observe.length>0&&-1===e.utils.arrayIndexOf(i.observe,o))return t[a]=e.utils.unwrapObservable(l),void(i.copiedProperties[o]=!0);e.isWriteableObservable(t[a])?(l=e.utils.unwrapObservable(l),t[a]()!==l&&t[a](l)):(l=void 0===t[a]?l:e.utils.unwrapObservable(l),t[a]=l),i.mappedProperties[o]=!0}}))}else switch(r.getType(n)){case"function":E()?e.isWriteableObservable(n)?(n(P(n)),t=n):t=P(n):t=n;break;default:var U;if(e.isWriteableObservable(t))return E()?(U=P(t),t(U),U):(U=e.utils.unwrapObservable(n),t(U),U);var X=j()||E();if(t=j()?I():e.observable(e.utils.unwrapObservable(n)),E()&&t(P(t)),X)return t}return t}function p(e,r,t){for(var n=0,a=e.length;a>n;n++)if(!0!==t[n]&&e[n]===r)return n;return null}function l(t,n){var a;return n&&(a=n(t)),"undefined"===r.getType(a)&&(a=t),e.utils.unwrapObservable(a)}function f(r,t,n){for(var a=0,i=(r=e.utils.unwrapObservable(r)).length;i>a;a++){var o=r[a];if(l(o,n)===t)return o}throw new Error("When calling ko.update*, the key '"+t+"' was not found!")}function c(r,t){return e.utils.arrayMap(e.utils.unwrapObservable(r),(function(e){return t?l(e,t):e}))}function v(e,t){if("array"===r.getType(e))for(var n=0;n<e.length;n++)t(n);else for(var a in e)e.hasOwnProperty(a)&&t(a)}function d(e){if(null===e)return!1;var t=r.getType(e);return"object"===t||"array"===t}function b(e){return(""+e).replace(/~/g,"~~").replace(/\[/g,"~[").replace(/]/g,"~]").replace(/\./g,"~.")}function y(){var r=[],t=[];this.save=function(n,a){var i=e.utils.arrayIndexOf(r,n);i>=0?t[i]=a:(r.push(n),t.push(a))},this.get=function(n){var a=e.utils.arrayIndexOf(r,n);return a>=0?t[a]:void 0}}function g(){var e={},r=function(r){var t;try{t=r}catch(e){t="$$$"}var n=e[t];return e.hasOwnProperty(t)||(n=new y,e[t]=n),n};this.save=function(e,t){r(e).save(e,t)},this.get=function(e){return r(e).get(e)}}e.mapping=r;var O,h,w="__ko_mapping__",m=e.dependentObservable,k=0,T=["create","update","key","arrayChanged"],x={},j={include:["_destroy"],ignore:[],copy:[],observe:[]},I=j;r.isMapped=function(r){var t=e.utils.unwrapObservable(r);return t&&t[w]},r.fromJS=function(e){if(0===arguments.length)throw new Error("When calling ko.fromJS, pass the object you want to convert.");try{var r,t;k||(O=[],h=new g),k++,2===arguments.length&&(arguments[1][w]?t=arguments[1]:r=arguments[1]),3===arguments.length&&(r=arguments[1],t=arguments[2]),t&&(r=a(r,t[w]));var n=s(t,e,r=i(r));if(t&&(n=t),!--k)for(;O.length;){var o=O.pop();o&&(o(),o.__DO.throttleEvaluation=o.throttleEvaluation)}return n[w]=a(n[w],r),n}catch(e){throw k=0,e}},r.fromJSON=function(t){var n=Array.prototype.slice.call(arguments,0);return n[0]=e.utils.parseJson(t),r.fromJS.apply(this,n)},r.toJS=function(t,n){if(I||r.resetDefaultOptions(),0===arguments.length)throw new Error("When calling ko.mapping.toJS, pass the object you want to convert.");if("array"!==r.getType(I.ignore))throw new Error("ko.mapping.defaultOptions().ignore should be an array.");if("array"!==r.getType(I.include))throw new Error("ko.mapping.defaultOptions().include should be an array.");if("array"!==r.getType(I.copy))throw new Error("ko.mapping.defaultOptions().copy should be an array.");return n=i(n,t[w]),r.visitModel(t,(function(r){return e.utils.unwrapObservable(r)}),n)},r.toJSON=function(t,n,a,i){var o=r.toJS(t,n);return e.utils.stringifyJson(o,a,i)},r.defaultOptions=function(){return arguments.length>0?void(I=arguments[0]):I},r.resetDefaultOptions=function(){I={include:j.include.slice(0),ignore:j.ignore.slice(0),copy:j.copy.slice(0),observe:j.observe.slice(0)}},r.getType=function(e){if(e&&"object"==typeof e){if(e.constructor===Date)return"date";if(e.constructor===Array)return"array"}return typeof e},r.visitModel=function(t,n,a){(a=a||{}).visitedObjects=a.visitedObjects||new g;var o,u=e.utils.unwrapObservable(t);if(!d(u))return n(t,a.parentName);a=i(a,u[w]),n(t,a.parentName),o="array"===r.getType(u)?[]:{},a.visitedObjects.save(t,o);var s=a.parentName;return v(u,(function(t){var i=b(t);if(!a.ignore||-1===e.utils.arrayIndexOf(a.ignore,i)){var p=u[t];if(a.parentName=function(e,t,n){var a=e||"";return"array"===r.getType(t)?e&&(a+="["+b(n)+"]"):(e&&(a+="."),a+=b(n)),a}(s,u,t),-1===e.utils.arrayIndexOf(a.copy,i)&&-1===e.utils.arrayIndexOf(a.include,i)){var l=u[w];if(l){var f=l.mappedProperties;if(f&&!f[i]){var c=l.copiedProperties;if(c&&!c[i]&&"array"!==r.getType(u))return}}}switch(r.getType(e.utils.unwrapObservable(p))){case"object":case"array":case"undefined":var v=a.visitedObjects.get(p);o[t]="undefined"!==r.getType(v)?v:r.visitModel(p,n,a);break;default:o[t]=n(p,a.parentName)}}})),o}}));
