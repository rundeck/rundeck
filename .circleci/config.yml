version: 2.1

parameters:
  node-version:
    type: string
    default: 18.18.1


orbs:
  aws-cli: circleci/aws-cli@1.0.0
  node: circleci/node@5.1.0
  trigger: rundeck/trigger-pipeline@0.0.5
  slack: circleci/slack@4.4.0
  browser-tools: circleci/browser-tools@1.4.6

# Slack notifier
slack-fail-post-step: &slack-fail-post-step
  post-steps:
    - slack/notify:
        channel: C01D89KV4JX
        branch_pattern: main
        event: fail
        custom: |
          {
          	"blocks": [
          		{
          			"type": "section",
          			"fields": [
          				{
          					"type": "mrkdwn",
          					"text": ":red_circle: *Job Failed*: ${CIRCLE_JOB}"
          				}
          			]
          		},
          		{
          			"type": "context",
          			"elements": [
          				{
          					"type": "mrkdwn",
          					"text": "*Project*: $CIRCLE_PROJECT_REPONAME"
          				},
          				{
          					"type": "mrkdwn",
          					"text": "*Branch*: $CIRCLE_BRANCH"
          				},
          				{
          					"type": "mrkdwn",
          					"text": "*Author*: $CIRCLE_USERNAME"
          				}
          			]
          		},
          		{
          			"type": "actions",
          			"elements": [
          				{
          					"type": "button",
          					"text": {
          						"type": "plain_text",
          						"text": "View Job"
          					},
          					"url": "${CIRCLE_BUILD_URL}"
          				}
          			]
          		}
          	]
          }


#### Executors ####

executors:

  # Main docker executor
  docker-builder:
    docker:
      - image: cimg/base:2023.10-22.04
    parameters:
      # we set the resource class to small by default
      # however, any job that uses the setup_remote_docker step will be
      # automatically upgraded to medium.
      resource_class:
        type: string
        default: small
    resource_class: << parameters.resource_class >>


  # Machine executor
  machine-builder:
    machine:
      image: ubuntu-2204:2023.10.1
      docker_layer_caching: << parameters.docker_layer_caching >>
    parameters:
      resource_class:
        type: string
        default: medium
      # TIP: Circle layer caching is only useful for jobs that build images.
      docker_layer_caching:
        type: boolean
        default: false
    resource_class: << parameters.resource_class >>


#### Commands ####

commands:

  # Setup docker remote for usage in builds
  setup_docker:
    parameters:
      # TIP: Circle layer caching is only useful for jobs that build images.
      docker_layer_caching:
        type: boolean
        default: false
    steps:
      - setup_remote_docker:
          docker_layer_caching: << parameters.docker_layer_caching >>
          version: 20.10.14

      # Due to circleci cli limitations, we need this workaround in order to run
      # the docker command as root on local builds, without running everything as root.
      # This step is NOT needed for normal operation.
      - run:
          name: Check if build is running locally
          command: |
            if [[ $CIRCLE_SHELL_ENV == *"localbuild"* && $CIRCLE_LOCAL_BUILD == "true" ]]; then
              echo "  !!!  Local build detected, setting up docker as root  !!!"
              sudo chmod u+s $(which docker)
            fi


  # Executes the env setup script and runs the specified commands
  run-build-step:
    description: "Runs a build command with full build environment"
    parameters:
      step-name:
        type: string
      command:
        type: string
      when:
        type: string
        default: on_success
    steps:
      - run:
          name: << parameters.step-name >>
          when: << parameters.when >>
          command: |
            source scripts/circleci/setup.sh
            echo "=== ENV ===" && env && echo "=== ENV END ==="
            set -x            
            <<parameters.command>>

  # Save gradle test results
  collect-gradle-tests:
    description: Collect JUNIT test reports from entire project
    steps:
      - run-build-step:
          step-name: Save test results
          when: always
          command: collect_gradle_tests
      - store_test_results:
          path: ~/test-results
      - store_artifacts:
          path: ~/test-results/junit

  # Restore Gradle Cache
  restore-build-cache:
    description: Restore Build cache
    steps:
      - restore_cache:
          keys:
            - cache-{{ .Environment.BUILD_CACHE_VERSION }}-build-cache-{{ .Branch }}-<<pipeline.number>>
            - cache-{{ .Environment.BUILD_CACHE_VERSION }}-build-cache-{{ .Branch }}-
            - cache-{{ .Environment.BUILD_CACHE_VERSION }}-build-cache-

  #Save gradle cache
  save-build-cache:
    description: Save Build cache
    steps:
      - save_cache:
          paths:
            - ~/.gradle/wrapper
            - ~/.gradle/caches
            - ~/.npm/_cacache
          key: cache-{{ .Environment.BUILD_CACHE_VERSION }}-build-cache-{{ .Branch }}-<<pipeline.number>>


  # Install node
  install-node:
    description: Install Node
    steps:
      - node/install:
          node-version: << pipeline.parameters.node-version >>

  # Install dependencies required for gradle builds.
  install-build-dependencies:
    description: Install Build Dependencies
    steps:
      - aws-cli/install
      - install-node
      - run-build-step:
          step-name: Install Build Dependencies
          command: dependencies_build_setup

  # Install dependencies required for packaging
  install-packaging-dependencies:
    description: Install Packaging Dependencies
    steps:
      - aws-cli/install
      - install-node
      - run-build-step:
          step-name: Install Packaging Dependencies
          command: dependencies_packaging_setup

  # Install dependencies required for runnning testdeck
  install-testdeck-dependencies:
    description: Install TestDeck Dependencies
    steps:
      - aws-cli/install
      - install-node
      - run-build-step:
          step-name: Install TestDeck Dependencies
          command: dependencies_testdeck_setup


#### Job Definitions ####

# Default job config
job-defaults: &job-defaults
  # Using an absolute path here prevents issues with bash interpolations.
  working_directory: /home/circleci/workspace
  environment:
    CIRCLE_PIPELINE_NUM: << pipeline.number >>
    GRADLE_OPTS: -XX:MaxRAMPercentage=80.0
    JAVA_OPTS: -XX:MaxRAMPercentage=80.0
    JAVA_HOME: /usr/lib/jvm/zulu11

jobs:

  # Build rundeck War
  build-rundeck:
    <<: *job-defaults
    executor:
      name: docker-builder
      resource_class: large
    steps:
      - setup_docker:
          docker_layer_caching: true
      - checkout
      - install-build-dependencies
      - restore-build-cache
      - run-build-step:
          step-name: Build War
          command: rundeck_war_build
      - run-build-step:
          step-name: Build And Push Docker Images
          command: |
            rundeck_docker_build
            rundeck_docker_push
      - run-build-step:
          step-name: Verify Build
          command: rundeck_verify_build
      - run-build-step:
          step-name: Build Testdeck docker image
          command: |
            testdeck_build_rdtest
            testdeck_push_rdtest
      - persist_to_workspace:
          root: ~/workspace
          paths:
            - core/build
            - rundeckapp/build
            - plugins/*/build
            - rundeck-*/build
            - grails-*/build
            - rundeck-storage/rundeck-*/build
            - rundeck-authz/rundeck-*/build
      #            - rundeckapp/grails-spa/packages/ui-trellis/build
      #            - rundeckapp/grails-spa/packages/ui-trellis/node_modules
      - run-build-step:
          step-name: Collect Artifacts
          command: collect_build_artifacts
      - store_artifacts:
          path: artifacts
      - save-build-cache


  # Run Gradle Tests
  test-gradle:
    <<: *job-defaults
    executor:
      name: docker-builder
    steps:
      - setup_docker
      - checkout
      - install-build-dependencies
      - restore-build-cache
      - attach_workspace:
          at: ~/workspace
      - run-build-step:
          step-name: Run Gradle Tests
          command: rundeck_gradle_tests
      - collect-gradle-tests
      - save-build-cache

  # Run twistlock scan
  twistlock-scan-image:
    <<: *job-defaults
    executor:
      name: docker-builder
    parameters:
      continue:
        description: Continue successfully even if check fails
        type: boolean
        default: false
    steps:
      - setup_docker
      - checkout
      - run-build-step:
          step-name: Install Twistlock
          command: install_twistcli
      - run-build-step:
          step-name: Scan Image
          command: twistlock_scan || << parameters.continue >>
      - store_artifacts:
          path: ~/workspace/twistlock_scan_result.json
      - store_test_results:
          path: test-results

  #Openapi tests
  test-openapi:
    <<: *job-defaults
    executor:
      name: docker-builder
    steps:
      - checkout
      - install-build-dependencies
      - attach_workspace:
          at: ~/workspace
      - run-build-step:
          step-name: Run Redocly OpenAPI Linting
          command: openapi_tests

  # Trigger pipeline in the enterprise repo
  trigger-enterprise:
    executor:
      name: docker-builder
    steps:
      - trigger/trigger:
          debug: true
          branch: ${CIRCLE_BRANCH}
          token: '${CIRCLECI_API_TOKEN}'
          project-slug: 'gh/rundeckpro/rundeckpro'
          pipeline-number: '<<pipeline.number>>'

  # Publish Docker Images
  docker-publish:
    <<: *job-defaults
    executor:
      name: docker-builder

    steps:
      - setup_docker
      - checkout
      - install-build-dependencies
      - restore-build-cache
      - attach_workspace:
          at: ~/workspace
      - run-build-step:
          step-name: Build Docker Images
          command: rundeck_docker_build
      - run-build-step:
          step-name: Publish Docker Images
          command: rundeck_docker_publish

  # Publish Maven Packages to sonatype
  maven-publish:
    <<: *job-defaults
    executor:
      name: docker-builder

    steps:
      - setup_docker
      - checkout
      - install-build-dependencies
      - restore-build-cache
      - attach_workspace:
          at: ~/workspace
      - run-build-step:
          step-name: Publish to Sonatype
          command: packaging_publish_maven

  test-gradle-functional:
    <<: *job-defaults
    executor:
      name: machine-builder
      docker_layer_caching: true
      resource_class: medium
    parameters:
      test-image:
        description: Test image tag
        default: "rundeck/testdeck"
        type: string
      gradle-task:
        type: string
    steps:
      - checkout
      - install-build-dependencies
      - restore-build-cache
      - attach_workspace:
          at: ~/workspace
      - run-build-step:
          step-name: Pull images
          command: testdeck_pull_rundeck
      - run-build-step:
          step-name: Runs gradle test task << parameters.gradle-task >>
          command: |
            TEST_IMAGE=<< parameters.test-image >>
            GRADLE_TASK=<< parameters.gradle-task >>
            rundeck_gradle_functional_tests
      - collect-gradle-tests
      - store_artifacts:
          path: ~/workspace/functional-test/build/test-results/images

  # Publish all packages to packagecloud
  packaging-publish:
    <<: *job-defaults
    executor:
      name: docker-builder

    steps:
      - setup_docker
      - checkout
      - install-packaging-dependencies
      - restore-build-cache
      - attach_workspace:
          at: ~/workspace
      - run-build-step:
          step-name: Install & Setup
          command: packaging_setup
      - run-build-step:
          step-name: Install PackageCloud CLI
          command: install_package_cloud
      - run-build-step:
          step-name: Create Packages
          command: packaging_create_packages
      - run-build-step:
          step-name: Sign Packages
          command: packaging_sign
      - run-build-step:
          step-name: Test Packages
          command: packaging_test_packages
      - run-build-step:
          step-name: Publish Packages
          command: packaging_publish
      - run-build-step:
          step-name: Publish war
          command: packaging_publish_war
      - save-build-cache

  # Test packaging
  packaging-test:
    <<: *job-defaults
    executor:
      name: docker-builder

    steps:
      - setup_docker
      - checkout
      - install-packaging-dependencies
      - restore-build-cache
      - attach_workspace:
          at: ~/workspace
      - run-build-step:
          step-name: Install PackageCloud CLI
          command: install_package_cloud
      - run-build-step:
          step-name: Install & Setup
          command: packaging_setup
      - run-build-step:
          step-name: Create Packages
          command: packaging_create_packages
      - run-build-step:
          step-name: Sign Packages
          command: packaging_sign
      - run-build-step:
          step-name: Test Packages
          command: packaging_test_packages
      - save-build-cache


  # Run Testdeck job on docker executor.
  test-docker:
    <<: *job-defaults
    executor:
      name: docker-builder

    parameters:
      command:
        description: Command that will execute the docker tests
        type: string
    steps:
      - setup_docker:
          docker_layer_caching: true
      - checkout
      - install-testdeck-dependencies
      - attach_workspace:
          at: ~/workspace
      - run-build-step:
          step-name: Pull images
          command: testdeck_pull_rdtest
      - run-build-step:
          step-name: Run Test
          command: << parameters.command >>


  test-machine:
    <<: *job-defaults
    executor:
      name: machine-builder
      docker_layer_caching: true
      resource_class: << parameters.resource_class >>

    parameters:
      resource_class:
        type: string
        default: medium
      command:
        description: Command that will execute the docker tests
        type: string
    steps:

      - checkout
      - install-testdeck-dependencies
      - attach_workspace:
          at: ~/workspace
      - run-build-step:
          step-name: Pull images
          command: testdeck_pull_rdtest
      - run-build-step:
          step-name: Run Test
          command: << parameters.command >>


  # Run Testdeck job on machine executor.
  testdeck:
    <<: *job-defaults
    executor:
      name: machine-builder
      docker_layer_caching: true
      resource_class: << parameters.resource_class >>

    parameters:
      resource_class:
        type: string
        default: medium
      workdir:
        description: Working directory
        type: string
        default: .
      command:
        description: Command that will execute the docker tests
        type: string

    steps:

      - checkout
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - install-testdeck-dependencies
      - attach_workspace:
          at: ~/workspace
      - run-build-step:
          step-name: Pull Rundeck Image
          command: testdeck_pull_rundeck
      - run-build-step:
          step-name: Test
          command: |
            cd << parameters.workdir >>
            ./bin/deck bootstrap
            << parameters.command >>
      - run-build-step:
          step-name: Print Logs
          when: always
          command: |
            cd << parameters.workdir >>
            ./bin/deck cluster logs
      - store_artifacts:
          path: << parameters.workdir >>/test_out/images
          destination: images
      - store_test_results:
          path: << parameters.workdir >>/test_out


#### WORKFLOWS ####

slack-defaults: &slack-defaults
  context:
    - slack-secrets
  <<: *slack-fail-post-step

require-build: &require-build
  requires:
    - Build


workflows:

  build_and_publish:
    when:
      matches: { pattern: "/^v.*$/", value: <<pipeline.git.tag>> }

    jobs:
      - build-rundeck:
          name: Build Release
          <<: *slack-defaults
      - packaging-publish:
          name: Package and Release
          requires:
            - Build Release
          <<: *slack-defaults
      - maven-publish:
          name: Maven Publish
          requires:
            - Build Release
          <<: *slack-defaults
      - docker-publish:
          name: Docker Publish
          requires:
            - Build Release
          <<: *slack-defaults


  build_and_test:
    when: << pipeline.git.branch >>
    jobs:
      - build-rundeck:
          name: Build
          <<: *slack-defaults
      - test-gradle:
          name: Gradle Test
          <<: *slack-defaults
      - trigger-enterprise:
          name: Enterprise Snapshot
          <<: *require-build
          filters:
            branches: { only: main }
      - test-openapi:
          name: OpenAPI Spec Validation
          <<: *require-build
          <<: *slack-defaults
      - packaging-test:
          name: Test Packaging
          <<: *require-build
          <<: *slack-defaults
      - twistlock-scan-image:
          name: Twistlock Scan Preview
          <<: *require-build
          continue: true
          context:
            - tl_scan_context
          filters:
            branches: { ignore: main }
      - twistlock-scan-image:
          name: Twistlock Scan
          continue: false
          context:
            - tl_scan_context
            - slack-secrets
          filters:
            branches: { only: main }
          <<: *require-build
          <<: *slack-fail-post-step
      - test-docker:
          name: Docker Test
          command: bash test/run-docker-tests.sh
          <<: *require-build
          <<: *slack-defaults
      - test-docker:
          name: Tomcat 8 API Test
          command: bash test/run-docker-tomcat-tests.sh 8-jdk11
          <<: *require-build
          <<: *slack-defaults
      - test-docker:
          name: Tomcat 9 API Test
          command: bash test/run-docker-tomcat-tests.sh 9-jdk11
          <<: *require-build
          <<: *slack-defaults
      - test-machine:
          name: API Test
          command: DOCKER_COMPOSE_SPEC=docker-compose-api-mysql.yaml bash test/run-docker-api-tests.sh
          <<: *require-build
          <<: *slack-defaults
      - test-docker:
          name: SSL Test
          command: bash test/run-docker-ssl-tests.sh
          <<: *require-build
          <<: *slack-defaults
      - test-docker:
          name: Ansible Test
          command: bash test/run-docker-ansible-tests.sh
          <<: *require-build
          <<: *slack-defaults
      - test-docker:
          name: Blocklist Test
          command: bash test/run-docker-plugin-blocklist-test.sh
          <<: *require-build
          <<: *slack-defaults
      - test-machine:
          name: LDAP Test
          command: bash test/run-docker-ldap-tests.sh
          <<: *require-build
          <<: *slack-defaults
      - test-machine:
          name: LDAP Bind Test
          command: DOCKER_COMPOSE_SPEC=docker-compose-ldap-binding-test.yaml bash test/run-docker-ldap-tests.sh
          <<: *require-build
          <<: *slack-defaults
      - test-docker:
          name: PAM Test
          command: bash test/run-docker-pam-tests.sh
          <<: *require-build
          <<: *slack-defaults
      - testdeck:
          name: Selenium Test
          workdir: test/selenium
          command: testdeck_selenium_test
          <<: *require-build
          <<: *slack-defaults
      - test-gradle-functional:
          name: New Selenium Test
          gradle-task: seleniumCoreTest
          <<: *require-build
          <<: *slack-defaults
      - test-gradle-functional:
          name: New API Test
          gradle-task: apiTest
          <<: *require-build
          <<: *slack-defaults
      - test-gradle-functional:
          name: New API Test Tomcat 8
          test-image: 8-jdk11
          gradle-task: tomcatTest
          <<: *require-build
          <<: *slack-defaults
      - test-gradle-functional:
          name: New API Test Tomcat 9
          test-image: 9-jdk11
          gradle-task: tomcatTest
          <<: *require-build
          <<: *slack-defaults
