services:
  rundeck:
    image: ${TEST_IMAGE}
    platform: ${TEST_TARGET_PLATFORM:-linux/amd64}
    environment:
      RUNDECK_GRAILS_URL: ${TEST_RUNDECK_GRAILS_URL}
      RUNDECK_SERVER_FORWARDED: 'true'
      RUNDECK_TOKENS_FILE: /home/rundeck/server/config/tokens.properties
      RUNDECK_MULTIURL_ENABLED: "true"
      RUNDECK_METRICS_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_GROUP_READINESS_INCLUDE: "readinessState,rundeckDataSourceHealthIndicator"
      MANAGEMENT_ENDPOINT_HEALTH_VALIDATE_GROUP_MEMBERSHIP: "false"
      RUNDECK_PLUGINS_PROVIDERBLOCKLISTFILE: /home/rundeck/blocklist.yaml
      # Grails 7: Increase Hikari connection pool for Selenium tests
      SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE: "20"
      SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE: "5"
      SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT: "60000"
    ports:
      - "4440:4440"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "/etc/timezone:/etc/timezone:ro"
      - "../../../tokens.properties:/home/rundeck/server/config/tokens.properties"
      - "../../../realm.properties:/home/rundeck/server/config/realm.properties"
      - "../../../blocklist-test/blocklist.yaml:/home/rundeck/blocklist.yaml"