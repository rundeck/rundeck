on:
  pull_request_target:
    types: [opened, synchronize, reopened, milestoned, demilestoned, edited]
    branches:
    - main

#check the milestones on the pr, and fail validation if no milestone is set, and the branch target is main
jobs:
  prcheck:
    permissions: 
      pull-requests: read
    name: PR Hygiene Check
    runs-on: ubuntu-latest
      
    steps:
      - name: PR requires a milestone
        if: github.event.action != 'edited'
        run: |
          MILESTONE=$(gh pr view $PR --json milestone -q .milestone)
          if [ $? != 0 ] ; then
            echo "Failed"
            exit 1
          fi
          if [ -z "$MILESTONE" ] ; then
            echo "::notice::Milestone is required"
            exit 2
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR: ${{ github.event.pull_request.html_url }}
      
      - name: PR requires at least one ticket number before title
        if: (github.event.action == 'edited' && github.event.changes.title) || contains(fromJSON('["opened", "reopened", "synchronize"]'), github.event.action)
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$TITLE" =~ ^RUN-[0-9]{3,6}( RUN-[0-9]{3,6})*: ]]; then
            echo "::error::PR title must start with 'RUN-####:' format. If specifying multiple ticket numbers, they must be separated by a single space (e.g., 'RUN-2921: A good title' or 'RUN-2921 RUN-2922: A good title with multiple tickets')."
            exit 1
          fi
          echo "::notice::PR title format is valid"